```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align="center")
```

```{r packages, include = FALSE}
library(tidyverse)
library(ggplot2)
library(ggmap)
library(factoextra)
library(ggfortify)
library(knitr)
library(kableExtra)
library(patchwork)
library(ggrepel)
library(fs)
library(Momocs)
library(broom)
library(magrittr)
```

```{r}
my_theme <-
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank(),
        axis.line = element_blank())
```

```{r data, echo=FALSE, message=FALSE}
neo_axes <- read_csv("data/micropasts-neoaxes1.csv", 
                     col_types = cols(.default = col_character())) %>%
  mutate(across(c("lat", "lon"), as.numeric))

neo_axes_long <- neo_axes %>%
  pivot_longer(areablad:weight, 
               names_to = "feature",
               values_to = "measurement") %>%
  filter(!is.na(measurement)) %>%
  mutate(across("measurement", as.numeric))

feature_n <- neo_axes_long %>%
  group_by(feature, condition) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  group_by(condition) %>%
  mutate(n_scaled = n / max(n)) %>%
  arrange(desc(n))

most_common_features <- feature_n %>%
  filter(n > 1200)

neo_axes_long_mcf <- neo_axes_long %>%
  semi_join(most_common_features, by = "feature") %>%
  filter(condition %in% c("complete", "roughout"))

second_cutoff_features <- feature_n %>%
  filter(n > 387)

neo_axes_long_19f <- neo_axes_long %>%
  semi_join(second_cutoff_features, by = "feature") %>%
  filter(condition %in% c("complete", "roughout"))
```

# Results

## Data collection outcomes

### Image processing of axe drawings

The cropping was mostly successful, and often produced three intended images: plan, profile and top. Exceptions appear to occur for some where the original drawings had been labeled, as bounding boxes were drawn around writing, identifying it as shapes, so sometimes writing was also cropped, or cropped instead of one or more of the views. Another exception occurs when views are drawn too close together or are overlapping, as these are then all included in the same cropped image. Finally some of the profile views were cropped in half as many of these have the edge drawn through the centre, which tends to be bolder than the outline. Another point of concern is that the crops do not leave much room around the outlines, which sometimes led to problems later with the filling.

The filling method was overall successful, and the shape of many axes was retained, but some data was lost on the outlines, causing them to become jagged. Despite mostly succeeding in cropping three views from each drawing, I decided to only focus on the plans as that is where most of the variation seems to occur between each axe. Only the plans which had two other associated images were chosen, as if there were less or more than three, the wrong view may have 'plan' in the filename and would be included in error. Of the 1825 axe drawings, this brought the number to import into Momocs down to 1198.

### Crowdsourcing with MicroPasts

All 1825 record sheets were transcribed, so the project is now listed as complete on MicroPasts, and the raw data is publicly available. This data collection method took by far the longest as volunteer uptake was slow, and individual tasks took a while to fill out, with 66 fields to complete. Mostly authenticated users took part in the project, however interestingly, some anonymous users also contributed a number of transcriptions. Investigation of the recovered data showed almost all of the features had impossible outliers due to data entry errors at the highest and lowest values. In the NGRs, a common error was that often, the two letters at the beginning of the NGRs were transcribed as numbers. In addition, a number of transcriptions had data missing, or were completely blank -- this was found to be due to a glitch on the MicroPasts website which caused the transcription to automatically submit when the enter key was pressed on a single-line field. Some volunteers had also added in their own notes in square brackets about the sheet they were transcribing, which was not in the instructions. These also needed to be removed as they were not part of the original dataset. Overall, however, the vast majority of data appears to have been entered correctly.

### Representativeness of data collected

Flaws in the cropping and filling processes to produce the silhouettes entailed that of the 1198 `r #length(outlines_uncorrected)` outlines imported into Momocs, only 1137`r #length(outlines)` could be used in the final analysis. The 61 outlines which were dropped were unrecognizable from their original drawings. The 1137`r #length(outlines)` usable outlines have had some slight data loss, for example their edges have become slightly more jagged, however not enough to truly affect the overall shape. For the record sheets, however, as much data will be retained as possible, as all 1825 sheets were transcribed. This will help to account for the axe drawings which cannot be included in the morphometric analysis with Momocs, as some educated guesses can be made about their shapes based upon analysis of their measurements and comparison with other similar axes which had usable silhouettes.

## Exploratory morphometric analysis with record sheet data

### Sorting variables

The data cleaning step after downloading the data from MicroPasts revealed that many axes did not have measurements for all 56 features. The dotplot shows a significant decrease in frequency of measurements for features below bladang (Figure \@ref(fig:features-dotplot)).

```{r features-dotplot, echo=FALSE, messsage=FALSE, fig.cap="Dotplot to visualise the amount of measurements for each feature and the conditions of the axes."}
neo_axes_long %>%
  group_by(feature) %>%
  mutate(n = n()) %>%
  # filter(n > 50) %>%
  ungroup() %>%
  mutate(feature = fct_reorder(feature, n, .desc = FALSE),
         id = fct_reorder(as.character(axe_id), n)) %>%
  ggplot(aes(colour = condition)) +
  geom_point(aes(x = id, y = feature), size=0.5) +
  theme(axis.text.x = element_blank())
        # axis.text.x = element_text(angle = 90, vjust = 0.5),
        #legend.position = c(.8, .4)) +

```

The data cleaning step after downloading the data from MicroPasts revealed that many axes did not have measurements for all 56 features. The dotplot shows a significant decrease in frequency of measurements for features below bladang (Figure \@ref(fig:features-dotplot)). A tally was created in order to choose a cut-off amount for the most frequently measured features, which showed that bladang was recorded 1202 times, whereas the next feature below it, maxleng, is recorded just 408 times. Using 1202 occurrences as the cut-off left 13 features, which helped to reduce dimensions considerably even before PCA.There is another cut-off point at lengmaxw which is recorded for 390 axes, which would include 19 variables, with these being more descriptive of shape than the 13 most recorded. Next, the conditions of the axes were considered. By far, the vast majority of axes were in complete condition. Roughout and cast condition axes were also kept as these retain the original or intended shape. Axes in other conditions were excluded. After these exclusions, 125 axes were omitted, leaving 1700 axes in the analysis.

### Univariate

At first glance, it is evident that many of the variables' densities show a fair amount of variation either side of the mean/median, they are mostly skewed, and mostly unimodal (Figure \@ref(fig:violin-plots)). Because some of these distributions are skewed due to outliers, I have provided red and blue lines for the mean and median, respectively, for each variable. Distance between the mean and median lines grows depending on the leptokursis of the variable. This is evident in corfroby, grinside, gripoled, lefedwid, longside, poledwid, and weight. The two grinding measurements are bimodal, whilst bladang and lonpoled appear to be trimodal. Bladang appears to have three modes very close together at more acute angles, with a rise in its tail at reflex angles. The mean and median are unhelpful measures of central tendency for these multimodal distributions, and instead we must look at the peaks (Shennan 1997, p39). Another noticeable outcome is that the cortex measurements seem to mostly be 0, with very little variation around the central values. Weight has the most skewed distribution of all, with values reaching more than 2000g, and the rug beneath the density showing that most of the weights fall below 1000g.

```{r density-plots, fig.cap="Density plots of the distribution of measurements for each feature."}
msrmnt_means <- neo_axes_long_mcf %>%
  group_by(feature) %>%
  summarise(mean.mm = mean(measurement, na.rm = TRUE))

msrmnt_meds <- neo_axes_long_mcf %>%
  group_by(feature) %>%
  summarise(med.mm = median(measurement, na.rm = TRUE))

neo_axes_long_mcf %>%
  ggplot(aes(x = measurement)) +
  geom_density(lwd = 0.5, alpha = 0.3, fill="skyblue1", color = "skyblue1") +
  geom_vline(data = msrmnt_means,
             mapping = aes(xintercept = mean.mm,
                           color = "mean")) +
  geom_vline(data = msrmnt_meds,
             mapping = aes(xintercept = med.mm,
                           color = "median")) +
  geom_rug(alpha = 0.5) +
  facet_wrap(~ feature, scales = "free", strip.position="bottom") +
  my_theme +
  theme(legend.position = "right",
        axis.text.y= element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 6),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  #expand_limits(x = 0, y = 0) +
  scale_color_manual(name = "statistics",
                     values = c(median = "blue", mean = "red"))
```

The violin plots show that all features have at least some outlier measurements (Figure \@ref(fig:violin-plots)). As many of the distributions are skewed, their interquartile ranges (IQRs) appear misleadingly tiny. For example, poledwid, whose IQR is a thin line just above 0, has outliers up to around 80mm. The cortex measurements are similarly difficult to see. However, corbaby and corbapl do appear to be mostly 0 as their outliers are not as extreme, so do not skew the axis. For the multimodal distributions, violin plots have proved a better choice than boxplots alone, as we can see that often the IQRs only spread around the most frequent mode, and also that the median is misleading. This is evident for grinside and lonpoled. As expected, the variation in bladang appears to concentrate at values just before 100, which is where the three peaks fall, however there are outliers at lower and higher values. We can also see that the most common values for weight are actually lower than 500, and that there are many outliers. Gripoled shows the most variation in most common values.

```{r violin-plots, fig.cap="Violin plots of measurement distribution for each feature."}
neo_axes_long_mcf %>%
  ggplot(aes(x = feature, y = measurement)) +
  # geom_boxplot(lwd = 0.25, outlier.size=0.25) +
  geom_violin(alpha = 0.3, fill="skyblue1", color = "skyblue1") +
  geom_boxplot(width=0.2, lwd = 0.25, outlier.size=0.25) +
  # geom_histogram(binwidth = 1, origin = 0) +
  facet_wrap(~ feature, scales = "free", strip.position="bottom") +
  my_theme +
  theme(legend.position = "none", strip.text = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())
```

The summary statistics further indicate skewed variables, such as poledwid, whose typical values fall between 0 and 3mm, whilst the maximum value is 85. Lefedwid is also similar with most values falling between 1 and 6mm, and a maximum value of 185. As expected, the variable with the largest range is weight, with an interquartile range of 300, its lowest value being 20g, with its maximum at 2165g. In addition, a typical blade angle lies between 80 and 90 degrees, and the largest is 180. The 1st and 3rd quartiles for the cortex measurements are both 0. After these univariate results, I decided to omit the cortex measurements as they were mostly 0 and only refer to the area of unpolished surface on the axe.

```{r summary-stats, message=FALSE, echo=FALSE, include=FALSE}
neo_axes_long_mcf2 <- neo_axes_long_mcf %>% 
  filter(!(feature %in% c("corfroby", "corbapl", "corfropl", "corbaby")))

neo_axes_wide <- neo_axes_long_mcf2 %>%
  pivot_wider(id = "axe_id", 
              names_from = "feature",
              values_from = "measurement") %>%
  column_to_rownames(var = "axe_id")

neo_axes_long_19f2 <- neo_axes_long_19f %>% 
  filter(!(feature %in% c("corfroby", "corbapl", "corfropl", "corbaby")))

neo_axes_wide19 <- neo_axes_long_19f2 %>%
  pivot_wider(id = "axe_id", 
              names_from = "feature",
              values_from = "measurement") %>%
  column_to_rownames(var = "axe_id")

# library(skimr)
# skim_without_charts(neo_axes_wide)

summary(neo_axes_wide)

# kable(summary(neo_axes_wide), booktabs = TRUE,
#     caption = "Summary statistics") %>%
# kable_styling(latex_options = "basic", font_size = 5)
```

### Principal components analysis

The first PC explains the most variance, however this is still just 38.8% of the overall variance; the second PC accounts for 16.8%, and the rest of the variance is split over many subsequent PCs (Figure \@ref(fig:screeplots)). The first two PCs account for 55.6% of the variance. PC3 and PC4 account for 10.9 and 10.1% respectively, in total explaining 21%, so these were also kept for analysis. The first 4 PCs account for 76.6% of the variance. Likewise, the eigenvalues for PC1 and PC2 are 3.5 and 1.5, which equates to 38.8% and 16.8% of the sum total of eigenvalues, which is 9.

```{r screeplots, fig.height=4, fig.width=6, fig.cap = "Screeplots of eigenvalues and percentage variance explained for PCA."}

neo_axes_wide_imputed <- 
  missMDA:::imputePCA(neo_axes_wide,
            method = "Regularized",
            ncp = 2)

mp_pca <- 
  prcomp(neo_axes_wide_imputed$completeObs,
         center = TRUE,
         scale = TRUE)

sc1 <- fviz_screeplot(mp_pca, addlabels = TRUE, choice = "eigenvalue", 
                      geom="bar", barcolor="skyblue1", barfill="skyblue1") +
  my_theme
sc2 <- fviz_screeplot(mp_pca, addlabels = TRUE, choice = "variance", 
                      geom="bar", barcolor="skyblue1", barfill="skyblue1") +
  my_theme

sc1 + sc2

```

Looking at the variable loadings, there are 4 variables which are strongly correlated with PC1, which are weight, maxthick, grinside and longside at 0.89, 0.83, 0.74 and 0.71 respectively (Table \@ref(tab:variable-loadings)).

\clearpage

```{r variable-loadings}

map_dfc(1:4, ~mp_pca$rotation[, .] * abs(mp_pca$sdev)[.]) %>%
  mutate(across(everything(), round, digits = 2)) %>%
  set_rownames(rownames(mp_pca$rotation)) %>%
  set_colnames(c("PC1", "PC2", "PC3", "PC4")) %>%
  arrange(desc(abs(PC1))) %>%
  kable(row.names=TRUE, 
      caption = "Variable loadings sorted by strongest correlation with PC1.", 
      booktabs = TRUE) %>%
  kable_styling(font_size = 10)
```

Gripoled, lefedwid and lonpoled are also moderately correlated. For PC2, its strongest correlation is with poledwid at -0.69, and is moderately correlated with longside, bladang and lefedwid. PC3 has no particularly strong correlations, however it mainly relates to lonpoled and gripoled. Finally, PC4's correlations are weaker still, with its strongest being grinside and lefedwid at 0.47 and 0.46.

The biplot for PC1 and PC2 shows the 4 variables which are strongly correlated with PC1 correlating with one another, and likewise for those correlated with PC2 (Figure \@ref(fig:pc1-pc2)).

```{r pc1-pc2, out.width="100%", fig.cap = "PCA: individuals and variables for PC1 and PC2."}

fviz_pca_biplot(mp_pca, title=element_blank(), col.var="black", 
                col.ind="skyblue1") +   coord_fixed()

```

Weight and maxthick are strongly correlated with one another, as are gripoled, lonpoled and lefedwid. The arrangement of the individuals on PC1 and PC2 shows long, heavy, thick axes with substantial grinding on their left side edges on the right, and the shortest, lightest, thinnest axes with smaller values for grinside on the left. For example, 62050 on the far right weighs 2085g, has a longside of 320mm, and a maxthick of 58mm. Similarly 60201 weighs 2110g with a longside of 270mm and a maxthick of 58mm. Meanwhile on the far left, which is difficult to discern as so many axes fall here, examples include 10787 which weighs just 25g with a longside of 45mm and 70006 weighing 30g with a longside of 70mm. Axes which are plotted further down PC2 have larger polls, for example 50027 and 70053 which have poledwid measurements of 80mm and 55mm.

\pagebreak

For PC3 and PC4, the biplot reveals some interesting inverse relationships between variables (Figure \@ref(fig:pc3-pc4)).

```{r pc3-pc4, out.width="100%", fig.cap = "PCA: individuals and variables for PC3 and PC4."}

fviz_pca_biplot(mp_pca, axes=c(3,4), title=element_blank(),
                col.ind="skyblue", col.var="black") +   coord_fixed()

```

Axes with larger lefedwid measurements tend to have smaller measurements for lonpoled, and vice versa; the same is happening with poledwid and gripoled, and potentially with grinside and maxthick. Axes further to the left of PC3 tend to have longer poll edges with more grinding, and to the right smaller measurements for both. For example, 70002 is 75mm for both, whereas on the opposite end, 50202 is 5mm for both. 50027 appears out of place on the far right of PC3 as it has 45mm for lonpoled and gripoled, however it has an outlier measurement for the more weakly correlated variable poledwid at 80mm, so this is deciding its placement. As the variable loadings are relatively weak for these PCs, in addition to how little variance they account for, it is difficult to discern the relations between axes on either side of PCs 3 or 4 (Shennan 1980, p267). PC4 appears to mainly be characterised by lefedwid and grinside. Axes at the top of this component tend to have larger measurements for both, for example 10953 has a grinside of 165cm<sup>2</sup> and lefedwid of 31mm, whilst on the other end, 10400 has a grinside of 0cm<sup>2</sup> and a lefedwid of 0mm.

As the dotplot showed that there were 369 axes which had measurements for 19 variables from maxwid upwards, and since those variables include some useful descriptors of shape, PCA was attempted again with these 19 variables but a reduced dataset of 390. For brevity, only PCs 1 and 2 will be analysed here (Figure \@/ref(fig:no-na-variable-loadings). The variable loadings show that 9 variables are correlated with PC1, with weight and maxwid being the strongest at 0.92 and 0.89 respectively; these are followed by maxthick, blawid, maxleng, blathick, longside, grinside and lengmaxt. For PC2, the strongest correlations are with polwid and polthick at -0.71 and -0.77, followed by moderate correlations with lonpoled, poleng, maxleng and poledwid.

```{r no-na-variable-loadings}
mp_pca_no_na <- drop_na(neo_axes_wide19) %>%
  prcomp(center = TRUE, scale = TRUE)

map_dfc(1:4, ~mp_pca_no_na$rotation[, .] * abs(mp_pca_no_na$sdev)[.]) %>%
  mutate(across(everything(), round, digits = 2)) %>%
  set_rownames(rownames(mp_pca_no_na$rotation)) %>%
  set_colnames(c("PC1", "PC2", "PC3", "PC4")) %>%
  arrange(desc(abs(PC1))) %>%
  kable(row.names=TRUE, 
      caption = "Variable loadings for PCA with all rows containing NA values removed: 369 axes left.", 
      booktabs = TRUE) %>%
  kable_styling(font_size = 10)
```

The biplot shows the variables which were most correlated with PC1 correlating with one another, and likewise for those which correlate the most with PC2. Interestingly, PC2 is characterised by all of the poll measurements, whilst PC1 relates to measurements which define the overall size of an axe. This is reassuringly very similar to the PCA results from all of the axes with 9 variables, as poledwid and lonpoled were correlated with PC2 and the overall size features correlated with PC1.

```{r no-na-pca, fig.cap="PCA with 19 variables measured for 369 axes."}

fviz_pca_biplot(mp_pca_no_na, title=element_blank(), col.var="black", 
                col.ind="skyblue1") +   coord_fixed()
```

\pagebreak

### K-means cluster analysis

The WSS plot displayed an 'elbow' or sudden change at 2, 5 and 8, whilst the average silhouette overwhelmingly indicated 2 as the optimal number of clusters with subsidiary peaks at 3 and 7 (Figure \@ref(fig:wss-silhouette)).

```{r wss-silhouette, fig.height=3, fig.cap="WSS and average silhouette plots for k-means clustering."}
mp_scaled <- neo_axes_wide_imputed$completeObs %>%
  # drop_na() %>%
  scale()

p1 <- fviz_nbclust(mp_scaled, kmeans, method = "wss") +
  my_theme
p2 <- fviz_nbclust(mp_scaled, kmeans, method = "silhouette") +
  my_theme

p1 + p2
```

In light of these results, k-means analyses were performed with clusters set to 2, 3 and 5 (Figure \@ref(fig:mp-kmeans)). The axes visible on the far left of the plot in cluster 1 of the 2-cluster arrangement are the same as those which were on the far left of PC1 in the PCA, which have the largest measurements for maxwid, weight, maxleng, and other variables which correlate strongly with PC1. These appear to be lumped in with smaller axes, such as 81005, weighing 285g, with a longside of 95mm. Cluster 2 contains the most individuals, and has the same smaller axes on its far right which were on the far left of PC1.

```{r mp-kmeans, echo=FALSE, message=FALSE, fig.cap="K-means analyses with 2, 3 and 5 clusters."}
mp_kmeans2 <- kmeans(mp_scaled, centers = 2, nstart = 50, algorithm = "Hartigan-Wong")
mp_kmeans3 <- kmeans(mp_scaled, centers = 3, nstart = 50, algorithm = "Hartigan-Wong")
mp_kmeans5 <- kmeans(mp_scaled, centers = 5, nstart = 50, algorithm = "Hartigan-Wong")

mp_kmeans3_lookup <- mp_kmeans3$cluster %>%
  enframe() %>%
  rename(axe_id = name, cluster = value) %>%
  mutate_at("cluster", ~ as_factor(as.character(.)))

k2 <- fviz_cluster(mp_kmeans2, data = mp_scaled, labelsize=6) +
  my_theme
k3 <- fviz_cluster(mp_kmeans3, data = mp_scaled, labelsize=6) +
  my_theme
k5 <- fviz_cluster(mp_kmeans5, data = mp_scaled, labelsize=6) +
  my_theme

k2 /
k3 /
k5 
```

Moving onto the 3 cluster plot, the axes on the extremities of the plot are still in the same places, however many of the axes which were on the borders between clusters 1 and 2 previously have now been relocated to cluster 1. Most of the axes tend to fall into clusters 1 and 2, which are similar sizes. This solution has removed some of the smaller axes from the cluster with the largest axes in, which is an improvement, however all clusters are partitioned through where most of the axes fall, almost appearing to overlap, which suggests poor partitioning or overfitting (Rhys 2019, p403). The axes with the largest poll measurements are all in cluster 2.

The 5-cluster plot has reassuringly made very little changes to the previous cluster 1 membership from the 3-cluster analysis, which has now become cluster 4, however some of the bordering axes were moved into cluster 3. The overlapping is now worse. Because this potential solution has made little changes to cluster 3 from the 3-cluster solution, plus clusters 2 and 3 appear to really be one cluster, and the same with clusters 5 and 4, the 3-cluster solution was chosen as the best option from these.

### Within-cluster densities

It is clear that cluster 3 mostly contains the axes with the largest values for grinside, longside, maxthick and weight (Figure \@ref(fig:cluster-densities)). Clusters 3 and 2 have similar modes for lonpoled and gripoled. Cluster 1 is clearly characterised by the smallest values for most variables, however it shares a mode with cluster 2 for longside. The bimodal distributions of grinside and gripoled are still evident here and it is clear which clusters cause these. For grinside, the subsidiary mode is due to one of cluster 1's modes, and the largest mode consists of the most common values for cluster 2, 3 and the other mode for cluster 1. Gripoled's main mode is just characterised by cluster 1, whilst its subsidiary mode is created by clusters 1 and 2. Bladang and poledwid do not show much difference in distributions between the clusters.

```{r cluster-densities, fig.height=3.5, fig.width=6, fig.cap="Density plots to show distribution of variables within 3 k-means clusters."}
neo_axes_long_mcf2 %>%
  right_join(mp_kmeans3_lookup, by = "axe_id") %>%
  ggplot(aes(x = measurement)) +
  geom_density(aes(colour = cluster, fill = cluster), alpha = 0.3) +
  # geom_density(alpha = 0.2) +
  # geom_rug(alpha = 0.5) +
  facet_wrap(~ feature, scales = "free") +
  my_theme +
  theme(legend.position = "right",
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size=6))
```

### Clusters on PCA

The clusters are very clearly visible on PC1 and PC2, but are amalgamated on PC3 and PC4 (\@ref(fig:pca-cluster)). All clusters overlap, with cluster 3 trailing off to the left, containing the axes with larger measurements for the variables correlated with PC1. Cluster 2 has all of the axes which have large measurements for variables correlated with PC2, however this could be a coincidence as they are also placed roughly in the same area of PC2 as the rest of cluster 2. Clusters 2 and 3 show a fair amount of variation on PCs 3 and 4, with cluster 1 mostly staying around the origin.

```{r pca-cluster, fig.height=10, fig.cap = "PCA of the first and second pairs of PCs with individuals coloured by k-means cluster."}

pcl1 <- fviz_pca_ind(mp_pca, 
                     habillage=mp_kmeans3$cluster) +   coord_fixed()
pcl2 <- fviz_pca_ind(mp_pca, axes=c(3,4), 
                     habillage=mp_kmeans3$cluster) +   coord_fixed()

pcl1 /
pcl2
```

\clearpage

## Outline morphometric analysis with Momocs

### Data sorting

The panel plot of the 1198 outlines imported into Momocs revealed a number of incorrect shapes resulting from the cropping and filling process (Figure \@ref(fig:image-sorting)).

```{r image-sorting, results='hide', warning=FALSE, message=FALSE, fig.height=6,  fig.cap="All outlines imported into Momocs before inspection"}

outlines_uncorrected <- read_rds("data/outlines.Rds")

panel(outlines_uncorrected)
```

The final dataset is below (Figure \@ref(fig:outline-corrections)). Some of the wider, more square outlines are peculiar, however these do exist in the original drawings. In total, 61 outlines were removed.

```{r outline-corrections, fig.height=6, results='hide', message=FALSE, warning=FALSE, fig.cap="Final outlines for analysis after incorrect shapes removed"}

outline_errors <- read_csv("data/error-fills.csv") %>% pull()

errors <-
  tibble(stem = names(outlines_uncorrected)) %>%
  mutate(axe_id = str_extract(stem, "[0-9]{2,}[ab]*")) %>%
  filter(axe_id %in% outline_errors) %>%
  pull(stem)

outlines <- Out(
  outlines_uncorrected[which(!names(outlines_uncorrected) %in% errors)])

panel(outlines)
```

For the first, middle and last axes in the dataset, the harmonic power plots showed that there was no more noticeable improvement on the reconstructed shape after 12 harmonics (Figure \@ref(fig:harmonic-power)). This was also the case when running the `hcontrib` function on the entire dataset passed to efourier with 20 harmonics (Figure \@ref(fig:hcontrib)). As a result of these checks, 12 harmonics was settled on for the elliptical fourier transformation.

```{r harmonic-power, results='hide', message=FALSE, warning=FALSE, fig.cap="Cumulated harmonic power without the first harmonic for three outlines."}
#checking harmonic power, how many to use in ef
ef_first <- efourier(outlines[1], 12, norm=FALSE)

ef_mid <- efourier(outlines[599], 20, norm=FALSE)

ef_last <- efourier(outlines[1137], 20, norm=FALSE)

par(mfrow=c(2,2))

plot(cumsum(harm_pow(ef_first)[-1]), type='o',
     main="First outline",
     ylab='Cumulated harmonic power', xlab='Harmonic rank')

plot(cumsum(harm_pow(ef_mid)[-1]), type='o',
     main="Outline 599",
     ylab='Cumulated harmonic power', xlab='Harmonic rank')

plot(cumsum(harm_pow(ef_last)[-1]), type='o',
     main="Last outline",
     ylab='Cumulated harmonic power', xlab='Harmonic rank')

```

```{r hcontrib, fig.height=3.5, results='hide', message=FALSE, warning=FALSE, fig.cap="Harmonic contribution plot to show how many harmonics can reconstruct a typical axe outline."}
#elliptical fourier transform
ef <- efourier(outlines, 10)

hcontrib(ef, harm.r = 1:10, main=element_blank())
```

\clearpage

### PCA on elliptical-Fourier-transformed outlines

The PC contribution plot indicates that only the first three PCs explain any variation in the outlines (Figure \@ref(fig:pccontrib)). Here, we can see that the first PC accounts for width, and PC2 is characterised by the ratio of blade width to poll width. PC3 appears to distinguish rounder blades and edges from straighter blades and edges, but seems to contain shapes which do not exist. The rest of the PCs do not appear to show much variation at all.

```{r pccontrib, results='hide', message=FALSE, warning=FALSE, fig.cap="Variation in outlines explained by each principal component."}
mm_pca <- Momocs::PCA(ef)

pccontrib <- PCcontrib(mm_pca, nax=1:10)

#pccontrib$gg + geom_polygon(fill="thistle", col="slategrey")
```

Although some variation is shown in PCs 3 and 4, the proportion of overall variance they explain is negligible (Figure \@ref(fig:momocs-screeplot)). In light of this, only PC1 and PC2 were used for PCA.

```{r momocs-screeplot, fig.height=3, fig.width=3, fig.cap="Scree plot of proportion of variance explained by each principal component."}
scree_plot(mm_pca, nax=1:4) + my_theme
```

The mean shapes drawn onto the morphospace are wider toward the left of PC1 and thinner toward the right (Figure \@ref(fig:momocs-pca)). Mean shapes at the top of PC2 have much wider blades than polls, and wider polls than blades toward the bottom, with straight axe shapes appearing toward the origin. The majority of axe shapes fall around and just beyond the origin, represented by the mean shapes in the centre. The mean shapes on the morphospace show some odd, seemingly predictive shapes at the far edges where no axes are plotted, for example the almost bowling-pin-like shapes at the top and bottom right corners. At first glance it would appear that the shapes are facing two different directions, which was initially assumed to be due to incorrect alignment, however this has been observed in other studies which use Momocs (Bourcy 2013, p49, Figure 13). As PC2 appears to represent the ratio of blade to poll width, these odd shapes indicate an attempt to show thinness at opposing ends of the outline. On the far left of PC1 but in the centre of PC2, individuals are plotted where the mean shapes are wide and square. The vast majority of individuals appear to fall where the mean shapes are slightly narrower toward the poll edge and in the mid-range of thickness, represented by the shapes just to the left of and at the origin. In addition, some straight oblong shapes seem to be present in the dataset, plotted just to the right of the origin. Some less common shapes have also become evident here, with individuals plotted on the far left end of PC1 which are wide and square, and to the far right, which are slightly bulbous at the blade end. There are also a small amount of outliers at the top and bottom of PC2 just to the left of the origin, showing there are axes in the dataset with much larger blades than polls and vice versa.

```{r momocs-pca, results='hide', message=FALSE, warning=FALSE, fig.cap="PCA of elliptical Fourier-transformed outlines"}

Momocs:::plot.PCA(mm_pca)
```

### K-means analysis on the Momocs PCA results

The k-means function in Momocs very helpfully plots the clusters onto the PCA results, drawing the mean axe shape of each cluster onto the morphospace.

K-means objects for up to 10 clusters were created and their total within sum of squares were inspected, which showed that the greatest change was at 2 and 3 clusters, so these were chosen for analysis. A 4-cluster plot was also trialed to see if any of the clusters would retain their membership when a larger number of clusters was imposed.

Firstly, the 2-cluster solution shows more narrow, straighter axes in the blue cluster, and wider, slightly more trapezoidal axes in the purple. Both clusters appear about the same size. There is potential overfitting here as the groups split the densely populated area of the plot in two, and include outliers in with these more typical axe shapes (Figure \@ref(fig:momocs-2kmeans)).

```{r momocs-2kmeans, results='hide', fig.cap="Momocs k-means with 2 clusters"}

mm_kmeans2 <- KMEANS(mm_pca, centers = 2,
                 algorithm = "Hartigan-Wong") 
```

For 3 clusters, there is now a wider, more trapezoidal mean shape cluster in purple, a narrower, straighter shape cluster in red, and a shape which appears to be between these two extremes in the central blue cluster. The clustering of individuals around the origin has mostly been contained in the blue cluster, however some are still being split into the neighbouring red cluster with the most narrow shapes. The purple cluster contains the most extreme outliers (Figure \@ref(fig:momocs-3kmeans)).

```{r momocs-3kmeans, fig.cap="Momocs k-means with 3 clusters"}
mm_kmeans3 <- KMEANS(mm_pca, centers = 3,
                 algorithm = "Hartigan-Wong")
```

When attempting to separate the shapes into 4 clusters, the plot shows two very similar looking mean axe shapes for the central clusters which partition the majority of axes, however the thinnest group and the widest group now have more exaggerated mean shapes and smaller cluster membership (Figure \@ref(fig:momocs-4kmeans)). The wider axe group's mean shape now looks more squat, and the narrower axe group's mean shape is now even more narrow and straight. These probably account better for the axe shapes at both extremes. The two clusters in the centre show broadly similar shapes, however the blue cluster's axes will typically be thinner than those in the yellow cluster. Despite the total within cluster sum of squares not indicating much change at 4 clusters, this option does seem to be the most appealing, as although there may be overfitting of the two central clusters, the most narrow and most wide axes are best represented here. In addition, whilst the mean shapes of the blue and yellow clusters are similar, they do differ in width and straightness.

```{r momocs-4kmeans, fig.cap="Momocs k-means with 4 clusters"}
mm_kmeans4 <- KMEANS(mm_pca, centers = 4,
                 algorithm = "Hartigan-Wong")
```

### Outline cluster membership

In the panel plot with the clusters colour-coded, we can see that the widest axes are in the red cluster, and the most narrow, straightest axes are in the green (Figure \@ref(fig:panel-clusters)). The two similar clusters which were in the centre of the k-means plot do appear slightly different here, with the axes in the blue group being consistently thinner than those in the yellow. Axes in the blue group also appear to have wider blades than polls compared to the yellow group. Overall it seems that the aspect ratio of the outlines is the deciding factor in the groupings here, however the two wider groups tend to have more axes with wider blades than polls compared to the two narrower groups. The red group also contains all of the most square axes in the dataset, further suggesting that width of shapes is the cause for this partitioning.

```{r panel-clusters, message="hide", fig.cap='The 4 Momocs clusters colour coded onto a panel plot of axe outlines'}
outline_names <- names(outlines) %>% str_extract("[0-9]{2,}[ab]*")

#postscript(file="panel-clusters.ps")
panel(outlines,
      palette = col_spring,
      fac = as.factor(mm_kmeans4$cluster),
      #names = as.factor(outline_names),
      names = as.factor(mm_kmeans4$cluster),
      cex.names=0.5) 
#dev.off()

#include_graphics("panel-clusters.ps", dpi=600)
```

## Comparisons

The mean shapes of the 4 clusters revealed by using Momocs on the axe outlines show distinct shapes for each group (Figure \@ref(fig:momocs-meanshapes)). A typical axe from clusters 1 and 2 tends to be wider at the bottom than they are at the top, and is wider overall than those in clusters 3 and 4. Cluster 4 axes are almost entirely straight, and cluster 4 axes appear very squat.

```{r momocs-meanshapes, fig.height=4, fig.cap="Mean shapes for each of the 4 clusters"}

mm_meanshapes <- MSHAPES(ef, fac = as.factor(mm_kmeans4$cluster))
Out(mm_meanshapes$shp) %>% panel(names=TRUE)
```

Meanwhile, it is difficult to distinguish any difference between mean shapes of outlines within the 3-cluster solution from the k-means analysis of the axe measurements (Figure \@ref(fig:mp-data-meanshapes)). This is also the same for the mean shapes of outlines within 3 clusters on the reduced dataset with 19 variables (Figure \@ref(fig:mp-19f-meanshapes)).

```{r mp-data-meanshapes, fig.height=4, fig.cap="Mean shapes for the 3-cluster solution on the axe measurement data."}

mp_kmeans <- enframe(mp_kmeans3$cluster, name = "axe_id", value = "mp_cluster")

mm_kmeans <- enframe(mm_kmeans4$cluster, name = "stem", value = "mm_cluster") %>%
  mutate(axe_id = str_extract(stem, "[0-9]{2,}[ab]*"))

comparison <- full_join(mp_kmeans, mm_kmeans, by = "axe_id")

both <- comparison %>% filter(!is.na(stem)) %>% drop_na()

mp_cluster <- both %>%
  select(stem, mp_cluster) %>%
  deframe()

mp_meanshapes <- MSHAPES(ef, fac = as.factor(mp_cluster))
Out(mp_meanshapes$shp) %>% panel(names = TRUE)

```

```{r mp-19f-meanshapes, fig.height=4, fig.cap="Mean shapes for 3 clusters on axe measurement data with 19 variables."}
mp_scaled_19f <- neo_axes_wide19 %>%
  drop_na() %>%
  scale()
mp_kmeans3_19f <- kmeans(mp_scaled_19f, centers = 3, nstart = 50, algorithm = "Hartigan-Wong")

mp_kmeans_19f <- enframe(mp_kmeans3_19f$cluster, name = "axe_id", value = "mp_cluster_19f")

mm_kmeans <- enframe(mm_kmeans4$cluster, name = "stem", value = "mm_cluster") %>%
  mutate(axe_id = str_extract(stem, "[0-9]{2,}[ab]*"))

comparison_2 <- full_join(mp_kmeans_19f, mm_kmeans, by = "axe_id")

both <- comparison_2 %>% filter(!is.na(stem)) %>% drop_na()

mp_cluster_19f <- both %>%
  select(stem, mp_cluster_19f) %>%
  deframe()

mp_meanshapes_19f <- MSHAPES(ef, fac = as.factor(mp_cluster_19f))
Out(mp_meanshapes_19f$shp) %>% panel(names = TRUE)
```

```{r maps}
neo_axes_coords_kclust <-
  neo_axes %>%
  filter(!is.na(lat) & !is.na(lon)) %>%
  left_join(mp_kmeans3_lookup %>% rename(mp_cluster = cluster),
            by = "axe_id") %>%
  left_join(mm_kmeans %>% select(-stem),
            by = "axe_id") %>%
  select(axe_id, lon, lat, contains("cluster")) %>%
  mutate(across(contains("cluster"), as.character))

britain <- c(left = -7.5, bottom = 49.9, right = 2, top = 59)
britain_map <- get_stamenmap(britain, zoom = 7, maptype = "terrain-background",
                             color = "color", force = TRUE)

mp_map <- ggmap(britain_map, extent = 'device') +
  geom_point(aes(x = lon, y = lat),
             alpha = 0.8,
             filter(neo_axes_coords_kclust, !is.na(mp_cluster)),
             size = 1) +
  geom_density_2d(aes(colour = mp_cluster, x = lon, y = lat),
                  alpha = 0.8,
                  filter(neo_axes_coords_kclust, !is.na(mp_cluster)),
                  size = 1) +
  theme(legend.position = "right") +
  facet_grid(cols = vars(mp_cluster)) +
  my_theme +
  theme(legend.position = "none")

mm_map <- ggmap(britain_map, extent = 'device') +
  geom_point(aes(x = lon, y = lat),
             alpha = 0.8,
             filter(neo_axes_coords_kclust, !is.na(mm_cluster)),
             size = 1) +
  geom_density_2d(aes(colour = mm_cluster, x = lon, y = lat),
             alpha = 0.8,
             filter(neo_axes_coords_kclust, !is.na(mm_cluster)),
             size = 1) +
  theme(legend.position = "right") +
  facet_grid(cols = vars(mm_cluster)) +
  my_theme +
  theme(legend.position = "none")
  

mp_map / mm_map
```

```{r}
comparison %>%
  select(-stem, -axe_id) %>%
  group_by(mm_cluster, mp_cluster) %>%
  tally() %>%
  drop_na() %>%
  pivot_wider(names_from = mp_cluster,
              values_from = n) %>%
  mutate(total = `1` + `2` + `3`,
         across(1:3, ~`/`(.x, total) * 100))
```

