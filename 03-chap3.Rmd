```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

```{r include_packages_2, include = FALSE}
# This chunk ensures that the thesisdown package is
# installed and loaded. This thesisdown package includes
# the template files for the thesis and also two functions
# used for labeling and referencing
library(tidyverse)
library(ggplot2)
library(ggmap)
library(factoextra)
library(ggfortify)
library(knitr)
library(kableExtra)
library(patchwork)
```


```{r}
my_theme <-
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank(),
        axis.line = element_blank())
```

```{r data, echo=FALSE, message=FALSE}
neo_axes <- read_csv("data/micropasts-neoaxes1.csv", 
                     col_types = cols(.default = col_character()))

neo_axes_long <- neo_axes %>%
  pivot_longer(areablad:weight, 
               names_to = "feature",
               values_to = "measurement") %>%
  filter(!is.na(measurement)) %>%
  mutate(across("measurement", as.numeric))
```
#Results

##Data collection outcomes

###Image processing of axe drawings

The cropping was mostly successful, and often produced three images: plan, profile and top. Exceptions appear to occur for some where there are notes written near to the drawings, as bounding boxes were drawn around these, mistaking them for shapes, so sometimes these were also cropped, or cropped instead of one or more of the views. Another exception occurs when views are drawn too close together or are overlapping, as these are then all included in the same cropped image. Finally some of the profile views were cropped in half where the edge of the axe drawn does not have any gaps, which splits the profile in two. Another point of concern is that the crops do not leave much room around the outlines, which sometimes led to problems later with the filling.

The filling method was overall successful, and the shape of many axes was retained, but some data was lost on the outlines, causing them to become jagged, or some pointed parts were flattened or cut off. Of the 1825 axe drawings, 1137 were acceptable to use, as some of the filled in silhouettes were completely different to their original drawings. These were usually caused by more than one shape being included in the crop, which caused them all to be joined into one filled shape. Another issue was that the notes near to the outlines sometimes were joined to the rest of the silhouette, producing a non-existent shape. Although many of the 1137 usable silhouettes have had slight data loss on their outlines, they still mostly retain their original shapes.  Despite mostly succeeding in cropping three views from each drawing, I decided to only focus on the plans as that is where most of the variation seems to occur between each axe. Only the plans which had two other associated images were chosen, as if there were less or more than three, the wrong view may have ‘plan’ in the filename and would be included in error.

###Crowdsourcing with MicroPasts

All 1825 record sheets were transcribed, so the project is now listed as ‘complete’ on MicroPasts, and the raw data is publicly available. This data collection method took by far the longest as uptake for the tasks was slow, and individual tasks took a while to fill out, with over 56 fields to complete. Mostly authenticated users took part in the project, however interestingly, some anonymous users also contributed a number of transcriptions. Investigation of the recovered data showed almost all of the features had impossible outliers due to data entry errors at the highest and lowest values. Another common error in the data was that often, the two letters at the beginning of the NGRs were transcribed as numbers. In addition, a number of transcriptions had data missing, or were completely blank – this was most likely due to a glitch on the MicroPasts website which caused the transcription to automatically submit when the enter key was pressed on a single-line field. Some volunteers had also added in their own notes in square brackets about the sheet they were transcribing, which was not in the instructions. These also needed to be removed as they were not part of the original dataset. Overall, however, the vast majority of data appears to have been entered correctly. 

###Representativeness of data collected

Flaws in the filling-in and cropping process to produce the silhouettes entailed that only 1137 axes could be used in the final analysis. Of these 1137 axes, a number of them do look slightly different to their original drawings due to the dilation and eroding process needed to fill in each outline, but not enough really to affect the overall shape. A further few of these were removed later when inspecting the outlines after importing into Momocs. For the record sheets, however, as much data will be retained as possible, as all sheets were transcribed. This will help to account for the axe drawings which cannot be included in the morphometric analysis with momocs, as some educated guesses can be made about their shapes based upon analysis of their measurements and comparison with other similar axes which had usable silhouettes.

## Exploratory morphometric analysis with record sheet data

###Sorting variables

The data cleaning step after downloading the data from MicroPasts revealed that many axes did not have measurements for all 56 features. A dotplot was created to visualise how many times each feature had been measured, and the dots were also colour coded to represent the condition of the axe with that measurement recorded (Figure \@ref(fig:features-dotplot)). 

```{r features-dotplot, echo=FALSE, messsage=FALSE, fig.cap="Features dotplot"}
neo_axes_long %>%
  group_by(feature) %>%
  mutate(n = n()) %>%
  # filter(n > 50) %>%
  ungroup() %>%
  mutate(feature = fct_reorder(feature, n, .desc = FALSE),
         id = fct_reorder(as.character(axe_id), n)) %>%
  ggplot(aes(colour = condition)) +
  geom_point(aes(x = id, y = feature)) +
  theme(axis.text.x = element_blank()) +
        # axis.text.x = element_text(angle = 90, vjust = 0.5),
        #legend.position = c(.8, .4)) +
  my_theme
```

The dotplot shows that a sensible cut-off point for a feature to be included is at bladang, as it is recorded 1202 times, whereas the next feature below it, maxleng, is recorded just 408 times. This left 19 features in the analysis, which helped to reduce dimensions considerably even before PCA was undertaken. Next, the conditions of the axes were considered. By far, the vast majority of axes are in complete condition. As casts and roughouts retain the shape that axes were originally manufactured into, these were retained in addition to complete axes. The rest of the types were not included in the analysis as they do not represent the shapes that the axes were intended to be, or are broken/incomplete, and so cannot be compared. There are also some axes without the condition recorded, and these were also omitted from the analysis in case they were broken or modified. After these exclusions, 125 axes were omitted, leaving 1700 axes in the analysis. When inspecting the data for outliers, some measurements did not make sense in the context of the rest of the measurements for the same axe. For example, some of the lefedwids were much larger than the maxwid for the same axe, which created doubts that the lefedwid measurement was correct. In these instances, the lefedwids were also the largest in the dataset, skewing the distribution. However, as I am aiming to keep as much of the original data as possible, the outliers were still included.

```{r sorting, echo=FALSE, message=FALSE}
feature_n <- neo_axes_long %>%
  group_by(feature, condition) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  group_by(condition) %>%
  mutate(n_scaled = n / max(n)) %>%
  arrange(desc(n))

most_common_features <- feature_n %>%
  filter(n > 385)

neo_axes_long_mcf <- neo_axes_long %>%
  semi_join(most_common_features, by = "feature") %>%
  filter(condition %in% c("complete", "cast", "roughout"))
```

###Univariate

Density plots and boxplots were used to preliminarily explore the distributions of the remaining 19 variables before performing multivariate analysis. At first glance, it is evident that the many of the variables’ densities show a fair amount of variation either side of the mean/median (Figure \@ref(fig:density-plots)). Because some of these distributions are skewed due to outliers, I have provided lines to indicate the median and the mean for each. Skewed densities show space between the median and mean lines. Interestingly, there are a number of variables with potentially bimodal and even trimodal distributions, the most evident of these being the two grinding measurements, grinside and gripoled.  Blawid, blathick, blaleng, lengmaxt, maxwid, maxleng and polwid indicate potential bimodality, with a subsidiary peak towards smaller measurements. In addition, lonpoled and bladang appear to have three modes. Bladang appears to have three modes very close together at more acute angles, and a rise in its tail indicating that obtuse or reflex angles were also recorded. The mean and median are unhelpful measures of central tendency for these multimodal distributions, and instead we must look at the peaks (Shennan 1997, p39). Another noticeable outcome is that the cortex measurements appear to mostly be 0, with very little variation around the central values. Weight has the most skewed distribution of measurements of all, with values reaching more than 2000g, and the rug beneath the density showing that most of the weights fall below 1000g. Polwid appears the closest to a normal distribution.

```{r density-plots, message=FALSE, echo=FALSE, fig.cap="Density plots"}
msrmnt_means <- neo_axes_long_mcf %>%
  group_by(feature) %>%
  summarise(mean.mm = mean(measurement, na.rm = TRUE))

msrmnt_meds <- neo_axes_long_mcf %>%
  group_by(feature) %>%
  summarise(med.mm = median(measurement, na.rm = TRUE))

neo_axes_long_mcf %>%
  ggplot(aes(x = measurement)) +
  geom_density() +
  geom_vline(data = msrmnt_means, mapping = aes(xintercept = mean.mm),
             color = "red",
             linetype = "dashed") +
  geom_vline(data = msrmnt_meds, mapping = aes(xintercept = med.mm),
             color = "blue",
             linetype = "dashed") +
  geom_rug(alpha = 0.5) +
  facet_wrap(~ feature, scales = "free") +
  my_theme +
  theme(legend.position = "none") +
  expand_limits(x = 0, y = 0)
```

The amount of outliers for each variable are more visible in the boxplots (Figure \@ref(fig:boxplots)). Boxplots are particularly useful for distributions with one mode and limited skewedness, however can be misleading or unclear when used alone on any which are multimodal or very leptokurtic (Baxter 2015, p30). As many of the distributions are skewed, their interquartile ranges appear misleadingly tiny. For example, lefedwid, whose box is a thin line just above 0, but has outliers well over 150mm. Poledwid is similarly truncated. However, corbaby and corbapl do appear to be mostly 0 as their outliers are not as extreme, so do not skew the axis. The median is again no use for multimodal distributions, and the IQR only spreads around where the largest peak is, so subsidiary ones are ignored, however we can see their outliers. As expected, the variation in bladang appears to fall just before 100, which is where the three peaks fell in the density plot, however there are outliers at lower and higher values. We can also see that the most common values for weight are actually lower than 500, and that there are many outliers. Atypically low measurements are present in blawid, bladang and maxleng. Gripoled and polwid only have one outlier each and show significant variation. After the results of these plots, I decided to omit the cortex measurements as they were mostly 0 and only refer to the area of unpolished surface on the axe.

```{r boxplots, echo=FALSE, message=FALSE, fig.cap="Boxplots"}
neo_axes_long_mcf %>%
  ggplot(aes(x = feature, y = measurement)) +
  geom_boxplot() + 
  # geom_histogram(binwidth = 1, origin = 0) +
  facet_wrap(~ feature, scales = "free") +
  my_theme +
  theme(legend.position = "none", strip.text = element_blank())
```

Summary statistics of the variables make it easier to see which features are severely skewed (Table \@ref(tab:summary-stats)). For example, typical values for poledwid fall between 0 and 3mm, whilst the maximum value is 85. Lefedwid is also similar with most values falling between 1 and 6mm and a maximum value of 185. As expected, the variable with the largest range is weight, with an interquartile range of 300, its lowest value being 20g, and its highest value being 2165g. We can also see here that a typical blade angle lies between 80 and 90 degrees, and that the largest is 180. 

```{r summary-stats, message=FALSE, echo=FALSE}
neo_axes_long_mcf2 <- neo_axes_long_mcf %>% 
  filter(!(feature %in% c("corfroby", "corbapl", "corfropl", "corbaby")))

neo_axes_wide <- neo_axes_long_mcf2 %>%
  pivot_wider(id = "axe_id", 
              names_from = "feature",
              values_from = "measurement") %>%
  column_to_rownames(var = "axe_id")

kable(summary(neo_axes_wide), booktabs = TRUE, format = "latex",
      caption = "Summary statistics") %>%
kable_styling(latex_options = "scale_down")
```

\clearpage 

###K-means cluster analysis

To help decide the optimal amount of clusters to set in the kmeans analysis, the total within cluster sum of squares (WSS) and average silhouette were plotted (Figure \@ref(fig:wss-silhouette)).  

```{r wss-silhouette, echo=FALSE, message=FALSE, fig.cap="WSS and average silhouette plots"}
scaled_neo_axes <- neo_axes_wide %>%
  drop_na() %>%
  scale()

p1 <- fviz_nbclust(scaled_neo_axes, kmeans, method = "wss") +
  my_theme
p2 <- fviz_nbclust(scaled_neo_axes, kmeans, method = "silhouette") +
  my_theme

p1 + p2
```

The WSS plot indicated an ‘elbow’ or sudden change at 2, 3 and 6, with perhaps the most prominent being at 3. The average silhouette indicated 2 was the optimal number of clusters, with another peak at 4. Often it is best to compare multiple k-means solutions as it can be difficult to discern the optimal amount of clusters to use (Baxter 2015, p147), so each of these options were attempted (Figure \@ref(fig:k-means)). 

```{r k-means, echo=FALSE, message=FALSE, fig.height=10, fig.cap="K-means clusters"}
kclust2 <- kmeans(scaled_neo_axes, centers = 2, nstart = 50, algorithm = "Hartigan-Wong")
kclust3 <- kmeans(scaled_neo_axes, centers = 3, nstart = 50, algorithm = "Hartigan-Wong")
kclust4 <- kmeans(scaled_neo_axes, centers = 4, nstart = 50, algorithm = "Hartigan-Wong")
kclust6 <- kmeans(scaled_neo_axes, centers = 6, nstart = 50, algorithm = "Hartigan-Wong")

kclust3_lookup <- kclust3$cluster %>%
  enframe() %>%
  rename(axe_id = name, cluster = value) %>%
  mutate_at("cluster", ~ as_factor(as.character(.)))

kclust4_lookup <- kclust4$cluster %>%
  enframe() %>%
  rename(axe_id = name, cluster = value) %>%
  mutate_at("cluster", ~ as_factor(as.character(.)))

k2 <- fviz_cluster(kclust2, data = scaled_neo_axes) +
  my_theme
k3 <- fviz_cluster(kclust3, data = scaled_neo_axes) +
  my_theme
k4 <- fviz_cluster(kclust4, data = scaled_neo_axes) +
  my_theme
k6 <- fviz_cluster(kclust6, data = scaled_neo_axes) +
  my_theme

k2 /
k3 /
k4 /
k6
```

Judging by the measurements of some axes on either side of the 2-cluster k-means plot, heavier, thicker, longer axes were on the far left, and lighter, thinner and shorter ones were on the far right. For example, 60119, 60115 and 60128 all have maxlengs between 8 and 11mm and weigh 105, 135 and 140 respectively, whereas 60001, 60110 and 70002 have maxlengs of 299, 315, and 226, and weigh 1860, 1910 and 1565g. Interestingly, 60001 and 60110 have the longest maxlengs in the dataset, whilst 60119 and 60115 have the shortest,with 60128 having the 5th shortest. The clusters are partitioned through the part of the plot where most of the axes fall, almost appearing to overlap, which suggests poor partitioning or overfitting (Rhys 2019, p403).

Moving onto the 3 cluster plot, the axes on the extremeties of the plot are still in the same places, however many of the axes which fell towards the centre of the plot in either cluster have now been relocated into cluster 2. Most of the axes tend to fall into either cluster 2 or very near the edge of cluster 3. Here we can see better separation between the cluster with the longer/larger axes in and the other clusters, however there is overlap between clusters 1 and 2, which also are similar sizes, containing 166 and 143 points respectively. 

The 4-cluster plot appears to have kept the majority of the longer axes that were in cluster 1 in the same cluster, however some of the bordering axes moved into cluster 4. There is still overlap between two of the clusters, 3 and 4, where the majority of the axes fall, however some of what appears to be the shortest axes have been partitioned into a separate group with the least amount of axes in. Clusters 3 and 4 are similar sizes.

Finally, the 6-cluster solution interestingly shows that clusters 2 and 6 have mostly the same membership as clusters 1 and 3 in the 4-cluster plot with little if any change. There are now four overlapping clusters in the centre of the plot, which contain the majority of the axes in the dataset. These overlap so considerably that it is difficult to see their borders. As the 4-cluster plot was able to separate the two groups on the left and right of the plot which are retained when more clusters are introduced, it was decided that 4 clusters was the best choice for future analysis.

\pagebreak

### Within-cluster densities

It is clear that cluster 3 mostly contains the axes with the smallest values for blaleng, blathick, blawid, lengmaxt, maxleng, and polwid (Figure \@ref(fig:cluster-densities)). 

```{r cluster-densities, fig.cap="Cluster densities"}
neo_axes_long_mcf2 %>%
  right_join(kclust4_lookup, by = "axe_id") %>%
  ggplot(aes(x = measurement)) +
  geom_density(aes(colour = cluster, fill = cluster), alpha = 0.3) +
  # geom_density(alpha = 0.2) +
  # geom_rug(alpha = 0.5) +
  facet_wrap(~ feature, scales = "free") +
  my_theme +
  theme(legend.position = "right")
```

Cluster 2 appears to contain the lightest, thinnest axes, however not the shortest, and also has the lowest values for grinside. Cluster 4’s distribution overlaps with cluster 2’s on a number of the variables, however generally tends to peak at slightly higher numbers than cluster 2. Finally, cluster 1 generally appears to have the highest values within it for most variables, however its distribution is not always dominated by these, for example for lengmaxw where it has a wide spread. In addition, whilst cluster 4 contains the highest values for weight, its peak is at lower values than cluster 3’s. Cluster 1 axes tend to score highly on maxwid, longside, maxthick, grinside, lengmaxw more than the other clusters. Clusters 1, 2 and 3 appear to be widely spread for blaleng, blathick, blawid, lengmaxt, and polwid. Interestingly, all clusters show multiple modes for grinside and gripoled. Poleng, poledwid and bladang appear to have similar distributions in all clusters.

###Principal components analysis

Scree plots were examined to determine the number of PCs which explain the most variance. The first PC accounts for the most variance, however this is still just 38.2% of the overall variance; the second PC accounts for 14.8, and then the rest of the variance is split over many subsequent PCs (Figure \@ref(fig:screeplots)). The first two PCs account for 53% of the variance. PC3 and PC4 account for 8.9 and 7.2% respectively, in total 16.1%, so these were also kept for analysis. The first 4 PCs account for 69.1% of the variance.

```{r screeplots, fig.cap = "Screeplots of eigenvalues and percentage variance explained"}

neo_axes_PCA <- drop_na(neo_axes_wide) %>%
  prcomp(center = TRUE, scale = TRUE)

sc1 <- fviz_screeplot(neo_axes_PCA, addlabels = TRUE, choice = "eigenvalue") +
  my_theme
sc2 <- fviz_screeplot(neo_axes_PCA, addlabels = TRUE, choice = "variance") +
  my_theme

sc1 + sc2

```

If we imagine that the variables  are in alphabetical order, the rows in the variable loadings table begin with bladang and end with weight, and the columns are the principal components, or dimensions (Figure \@ref(tab:variable-loadings)). There are 9 variables which are strongly negatively correlated with PC1, with maxwid and weight being the strongest at -0.85 and -0.84 respectively. Maxthick, maxleng, blawid, blathick, blaleng, lengmaxt and longside are the other 7 variables. The negative correlation means that axes which have large measurements for these features will be on the far left of the plot. For PC2, polthick and polwid are strongly positively correlated, and longside is strongly negatively correlated. This means that axes which have large polthick and polwid measurements will be higher up PC2, and those with larger longside measurements will be lower. Finally, for PC3, bladang, gripoled and lefedwid have the strongest correlations and are positive, and poleng is the only strongly correlated variable with PC4, with a positive correlation.

```{r variable-loadings}

kable(map_dfc(1:19, ~neo_axes_PCA$rotation[, .] * sqrt(neo_axes_PCA$sdev ^ 2)[.]), caption = "Variable loadings", booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down")
```

The variable biplot for PC1 and PC2 shows that most of the variables corrleate with one another, with the exception of polwid, polthick, poleng, bladang, and lonpoled, which correlate with one another but less so with the rest. Polthick correlates the least with any variables. Longside, grinside and lefedwid are almost perfectly correlated, as are blawid and blaleng (Figure \@ref(fig:pc1-pc2)). The biplot of the individuals for PC1 and PC2 shows long, heavy, thick axes with thick blades on the far left side, and the shortest, lightest, thinnest axes with the thinnest blades on the far right. In the centre of the plot we see the majority of the axes, however there are some outliers toward the top of the plot which score highly on the poll measurements represented by PC2, such as 10040 and 81004. Some axes toward the centre score highly on only some of the negatively correlated variables in PC1. For example, 60072 is fairly long with a maxleng of 113mm, but weighs just 160g. Meanwhile, 60117 weighs 955g but is only 21.3mm long, and is positioned at the bottom of the plot since it has small polthick and polwid measurements.

```{r pc1-pc2, fig.height=10, fig.cap = "PCA: individuals and variables for PC1 and PC2"}

pc1 <- autoplot(neo_axes_PCA, x = 1, y = 2, variance_percentage = TRUE, label = TRUE, label.repel = TRUE, label.size = 2) + my_theme
pc2 <- autoplot(neo_axes_PCA, x = 1, y = 2, variance_percentage = TRUE, colour = 'grey', loadings.label = TRUE, loadings.colour = 'blue', loadings.label.colour = 'blue', loadings.label.repel = TRUE) + my_theme

pc1 /
pc2

```

For PC3 and PC4, the variable biplot shows bladang and lefedwid, the positively correlated variables with PC3, correlating with one another (Figure \@ref(fig:pc3-pc4)). The individuals biplot shows that there are a few axes which score highly on these extending to the right of the plot, however the vast majority fall around the centre. We can also see lengmaxt and maxleng correlating with one another, which are negatively correlated with PC3, and some long axes extending to the left of the plot. Finally we can see poleng, strongly positively correlated with PC4, extending vertically to the top of the plot, however there is just one outlier scoring highly on this variable. Examining PCs other than 1 and 2 can reveal outliers which were not visible on the first two PCs, such as 81004 which has the largest poleng measurement at 52mm, and 60126 which has a bladang of 180 degrees. As the variable loadings are not as strong for these PCs, in addition to how little variance they explain, it is difficult to discern the relations between axes on either side of PCs 3 and 4 (Shennan 1980, p267).

```{r pc3-pc4, fig.height = 10, fig.cap = "PCA: individuals and variables for PC2 and PC3"}

pc3 <- autoplot(neo_axes_PCA, x = 3, y = 4, variance_percentage = TRUE, label = TRUE, label.repel = TRUE, label.size = 2) +
  my_theme
pc4 <- autoplot(neo_axes_PCA, x = 3, y = 4, variance_percentage = TRUE, colour = 'grey', loadings.label = TRUE, loadings.colour = 'blue', loadings.label.colour = 'blue', loadings.label.repel = TRUE) + my_theme

pc3 /
pc4

```

### Clusters on PCA

```{r pca-cluster, fig.cap = "Clusters colour-coded onto plots of the two pairs of axes"}
pcl1 <- autoplot(neo_axes_PCA, data = kclust4, x = 1, y = 2, variance_percentage = TRUE, colour = 'cluster') + my_theme
pcl2 <- autoplot(neo_axes_PCA, data = kclust4, x = 3, y = 4, variance_percentage = TRUE, colour = 'cluster') + my_theme

pcl1 /
pcl2
```

